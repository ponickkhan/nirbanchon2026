<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>নির্বাচন ২০২৬ — পোস্টার নির্মাতা (বাংলাদেশ)</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700;900&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --ink:#11131a; --muted:#5f667a; --line:#d7dbe7; --brand:#136f63; --accent:#e63946; --bg:#f6f8ff;
    --bangla:"Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
    --latin:"Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
    --panel-width: 360px;
    --gap: 14px;
    --padding: 14px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:var(--bangla) }

  .app{
    display:grid; 
    grid-template-columns: var(--panel-width) 1fr; 
    gap:var(--gap);
    height:100svh; 
    padding:var(--padding);
    min-height: 600px;
  }
  
  /* Mobile Layout */
  @media (max-width: 768px) {
    .app {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
      padding: 8px;
      gap: 8px;
      height: 100vh;
      height: 100dvh;
    }
  }
  
  /* Tablet Layout */
  @media (min-width: 769px) and (max-width: 1024px) {
    .app {
      grid-template-columns: 320px 1fr;
      padding: 12px;
      gap: 12px;
    }
  }

  .panel{ 
    background:#fff; 
    border:1px solid var(--line); 
    border-radius:12px; 
    overflow:auto; 
    padding:12px;
    max-height: 100%;
  }
  
  @media (max-width: 768px) {
    .panel {
      max-height: 40vh;
      border-radius: 8px;
      padding: 8px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
  }
  .panel h2{ font-size:16px; margin:10px 0; letter-spacing:.3px }
  
  /* Collapsible Sections */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    padding: 8px 0;
    border-bottom: 1px solid var(--line);
    margin-bottom: 8px;
    user-select: none;
  }
  
  .section-header h2 {
    margin: 0;
    flex: 1;
  }
  
  .section-toggle {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--line);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    color: var(--muted);
    transition: all 0.2s ease;
  }
  
  .section-header:hover .section-toggle {
    background: var(--brand);
    color: white;
  }
  
  .section-content {
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.2s ease;
    max-height: 1000px;
    opacity: 1;
  }
  
  .section-content.collapsed {
    max-height: 0;
    opacity: 0;
    margin: 0;
  }
  
  .section-toggle.collapsed::after {
    content: '+';
  }
  
  .section-toggle:not(.collapsed)::after {
    content: '−';
  }
  
  /* Section Categories */
  .section-category {
    background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
    border-radius: 12px;
    margin: 12px 0;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .section-category.essential .section-header {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    margin: 0;
    padding: 12px 16px;
  }
  
  .section-category.styling .section-header {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    margin: 0;
    padding: 12px 16px;
  }
  
  .section-category.advanced .section-header {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    margin: 0;
    padding: 12px 16px;
  }
  
  .section-category.actions .section-header {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    color: white;
    margin: 0;
    padding: 12px 16px;
  }
  
  .section-category .section-content {
    padding: 16px;
  }
  
  .group{ border:1px solid var(--line); border-radius:10px; padding:10px; margin:8px 0; background:#fbfcff }
  
  /* Enhanced Visual Hierarchy */
  .group h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--brand);
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .section-divider {
    border-top: 2px solid var(--line);
    margin: 20px 0 15px 0;
    position: relative;
  }
  
  .section-divider::after {
    content: attr(data-title);
    position: absolute;
    top: -10px;
    left: 12px;
    background: white;
    padding: 0 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  /* Quick Action Buttons */
  .quick-actions {
    background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
    border: 1px solid var(--brand);
    border-radius: 12px;
    padding: 12px;
    margin: 12px 0;
  }
  
  .quick-actions h3 {
    color: var(--brand);
    margin-bottom: 10px;
  }
  
  /* Chips reorganization */
  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 8px 0;
    max-height: 120px;
    overflow-y: auto;
    padding: 4px;
  }
  
  .chips::-webkit-scrollbar {
    width: 4px;
  }
  
  .chips::-webkit-scrollbar-track {
    background: var(--line);
    border-radius: 2px;
  }
  
  .chips::-webkit-scrollbar-thumb {
    background: var(--brand);
    border-radius: 2px;
  }
  .row{ display:flex; gap:10px; align-items:center; margin:8px 0; flex-wrap:wrap }
  .row label{ font-size:12px; color:var(--muted); min-width:120px }
  .row input[type="text"], .row select{
    flex:1 1 180px; min-width:180px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-family:var(--bangla);
  }
  
  @media (max-width: 768px) {
    .row {
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      margin: 6px 0;
    }
    .row label {
      min-width: auto;
      font-weight: 600;
    }
    .row input[type="text"], .row select {
      min-width: auto;
      width: 100%;
      padding: 12px;
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
  .row input[type="file"]{ flex:1 1 180px }
  .row input[type="range"]{ flex:1; min-width:120px }
  .row .mini{ width:110px }
  .btn{ 
    appearance:none; 
    border:1px solid var(--line); 
    background:#fff; 
    padding:10px 12px; 
    border-radius:10px; 
    font-weight:700; 
    cursor:pointer; 
    font-family:var(--bangla);
    touch-action: manipulation;
    min-height: 44px; /* Touch target size */
  }
  .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .btn.warn{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.block{ display:block; width:100% }
  
  @media (max-width: 768px) {
    .btn {
      padding: 12px 16px;
      font-size: 14px;
      border-radius: 8px;
      min-height: 48px;
    }
  }
  .btn:disabled{ opacity:0.5; cursor:not-allowed }
  .chips{ display:flex; flex-wrap:wrap; gap:6px }
  .chip{ 
    padding:8px 10px; 
    border:1px solid var(--line); 
    border-radius:999px; 
    cursor:pointer; 
    font-size:12px; 
    background:#fff; 
    user-select:none;
    touch-action: manipulation;
  }
  .chip.active{ background:#e8f5f2; border-color:#b6e1d9; }
  
  @media (max-width: 768px) {
    .chips {
      gap: 4px;
    }
    .chip {
      padding: 10px 12px;
      font-size: 13px;
      min-height: 40px;
      display: flex;
      align-items: center;
    }
  }

  /* BIGGER color pickers */
  .row input[type="color"]{
    width:160px; height:72px; padding:0; border:3px solid var(--line); border-radius:12px;
    background:#fff; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,.08);
  }
  input[type="color"]::-webkit-color-swatch-wrapper{ padding:0; border-radius:10px }
  input[type="color"]::-webkit-color-swatch{ border:none; border-radius:10px }
  input[type="color"]::-moz-color-swatch{ border:none; border-radius:10px }

  .stage-wrap{ display:grid; grid-template-rows: auto 1fr auto; gap:10px; min-width:0; height: 100%; }
  .toolbar{ 
    display:flex; 
    gap:8px; 
    align-items:center; 
    background:#fff; 
    border:1px solid var(--line); 
    border-radius:12px; 
    padding:10px;
    flex-wrap: wrap;
  }
  .toolbar .spacer{ flex:1; min-width: 100px; }
  .status{ font-size:12px; color:var(--muted) }
  
  @media (max-width: 768px) {
    .stage-wrap {
      grid-template-rows: auto 1fr;
      gap: 8px;
      height: 60vh;
      min-height: 400px;
    }
    .toolbar {
      padding: 8px;
      border-radius: 8px;
      gap: 6px;
    }
    .toolbar .spacer {
      min-width: auto;
      flex: 0 0 100%;
      order: 10;
    }
  }

  .canvas-wrap{
    display:flex; 
    align-items:center; 
    justify-content:center;
    background:repeating-conic-gradient(#f4f6ff 0% 25%, transparent 0% 50%) 0 0/22px 22px;
    border:1px dashed #dfe4f2; 
    border-radius:12px; 
    padding:16px; 
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    height: 100%;
    min-height: 300px;
  }
  
  @media (max-width: 768px) {
    .canvas-wrap {
      padding: 8px;
      border-radius: 8px;
      background-size: 16px 16px;
    }
  }

  #poster{ 
    position:relative; 
    background:#fff; 
    box-shadow:0 12px 28px rgba(16,24,40,.12), 0 2px 6px rgba(16,24,40,.06); 
    overflow:hidden; 
    transform-origin:center center;
    max-width: 100%;
    max-height: 100%;
  }
  .A4-portrait{ width:794px; height:1123px }
  .A3-portrait{ width:1123px; height:1586px }
  .Square{ width:1080px; height:1080px }
  
  @media (max-width: 768px) {
    #poster {
      transform-origin: center center;
    }
    .A4-portrait{ 
      width: 300px; 
      height: 424px; 
    }
    .A3-portrait{ 
      width: 300px; 
      height: 424px; 
    }
    .Square{ 
      width: 300px; 
      height: 300px; 
    }
  }
  
  @media (min-width: 769px) and (max-width: 1024px) {
    .A4-portrait{ 
      width: 400px; 
      height: 565px; 
    }
    .A3-portrait{ 
      width: 400px; 
      height: 565px; 
    }
    .Square{ 
      width: 400px; 
      height: 400px; 
    }
  }

  .bg-fill{ position:absolute; inset:0; background:#fff }
  .header{ position:absolute; left:0; right:0; top:0; padding:28px 32px; display:flex; gap:16px; align-items:center; color:#fff; min-height:180px }
  .header .party-logo{ width:68px; height:68px; object-fit:cover; border-radius:8px; background:#fff; border:3px solid rgba(255,255,255,.75) }
  .header .title{ display:flex; flex-direction:column; line-height:1.05 }
  .header .title .party{ font-weight:800; font-size:28px; letter-spacing:.3px }
  .header .title .election{ font-weight:600; opacity:.95 }
  .ribbon{ position:absolute; right:-60px; top:70px; transform:rotate(38deg); color:#fff; padding:8px 120px; font-weight:800; letter-spacing:1px; text-shadow:0 1px 2px rgba(0,0,0,.25) }
  .candidate{ position:absolute; left:32px; bottom:220px; display:flex; gap:18px; align-items:flex-end }
  .candidate .photo{ width:260px; height:320px; background:#eef2ff; border-radius:14px; object-fit:cover; border:6px solid #fff }
  .candidate .info{ display:flex; flex-direction:column; gap:6px }
  .candidate .name{ font-size:48px; font-weight:900; line-height:.95 }
  .candidate .role{ font-size:18px; opacity:.85 }

  /* Traditional poster styles */
  .traditional-banner{ 
    position:absolute; left:16px; right:16px; top:12px; 
    background:#000; color:#fff; padding:12px; text-align:center; 
    border-radius:8px; font-weight:800; font-size:14px;
    transform: perspective(600px) rotateX(2deg);
  }
  .curved-element{
    position:absolute;
    border-radius:50%;
    background:linear-gradient(45deg, var(--brand), var(--accent));
  }
  .formal-border{
    border: 3px solid #000;
    border-radius: 15px;
    box-shadow: inset 0 0 0 3px #fff, 0 0 0 1px #000;
  }

  /* Header shape variations */
  .header-wave {
    clip-path: polygon(0 0, 100% 0, 100% 75%, 0 100%);
  }
  .header-curve-bottom {
    clip-path: ellipse(100% 85% at 50% 0%);
  }
  .header-arch {
    clip-path: polygon(0 0, 100% 0, 100% 60%, 50% 100%, 0 60%);
  }
  .header-diagonal {
    clip-path: polygon(0 0, 100% 0, 85% 100%, 0 100%);
  }
  .header-rounded {
    border-radius: 0 0 50px 50px;
  }
  .header-scoop {
    clip-path: polygon(0 0, 100% 0, 100% 80%, 50% 100%, 0 80%);
  }
  .header-mountains {
    clip-path: polygon(0 0, 100% 0, 100% 70%, 80% 100%, 60% 80%, 40% 100%, 20% 80%, 0 100%);
  }
  .header-triangle {
    clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 80%, 0 100%);
  }

  /* Ribbon style variations */
  .ribbon-classic {
    right: -60px; top: 70px; transform: rotate(38deg);
    padding: 8px 120px; border-radius: 0;
  }
  .ribbon-banner {
    right: 20px; top: 50px; transform: rotate(0deg);
    padding: 12px 24px; border-radius: 8px;
    clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 50%, calc(100% - 15px) 100%, 0 100%, 15px 50%);
  }
  .ribbon-corner {
    right: 0px; top: 0px; transform: rotate(0deg);
    padding: 16px 20px 8px 24px; border-radius: 0 0 0 15px;
    clip-path: polygon(0 0, 100% 0, 100% 80%, 80% 100%, 0 100%);
  }
  .ribbon-curved {
    right: 10px; top: 60px; transform: rotate(-15deg);
    padding: 10px 32px; border-radius: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .ribbon-badge {
    right: 30px; top: 40px; transform: rotate(0deg);
    padding: 8px 16px; border-radius: 50px;
    border: 3px solid rgba(255,255,255,0.8);
    font-size: 12px; font-weight: 900;
  }
  .ribbon-stamp {
    right: 25px; top: 45px; transform: rotate(-8deg);
    padding: 12px 20px; border-radius: 0;
    border: 4px dashed rgba(255,255,255,0.9);
    font-family: 'Courier New', monospace; font-weight: 800;
  }
  .ribbon-hidden {
    display: none !important;
  }

  /* Ribbon positioning */
  .ribbon-pos-top-left { right: auto; left: -60px; top: 70px; transform: rotate(-38deg); }
  .ribbon-pos-center { right: auto; left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(0deg); }
  .ribbon-pos-bottom-right { top: auto; bottom: 120px; right: -60px; transform: rotate(38deg); }
  .ribbon-pos-bottom-left { right: auto; left: -60px; top: auto; bottom: 120px; transform: rotate(-38deg); }

  /* Layout modes */
  .layout-swapped .header { top: auto; bottom: 0; }
  .layout-swapped .footer { bottom: auto; top: 0; }
  .layout-swapped .candidate { top: 220px; bottom: auto; }
  .layout-swapped .slogan { top: 76px; bottom: auto; }
  
  .layout-inverted .header { top: auto; bottom: 0; }
  .layout-inverted .footer { bottom: auto; top: 0; }
  .layout-inverted .candidate { top: 220px; bottom: auto; }
  .layout-inverted .slogan { top: 76px; bottom: auto; }
  
  .layout-centered .header { height: 20% !important; }
  .layout-centered .footer { height: 20% !important; }
  .layout-centered .candidate { top: 50%; bottom: auto; transform: translateY(-50%); }
  .layout-centered .slogan { top: 60%; bottom: auto; }
  
  .layout-minimal-header .header { height: 15% !important; }
  .layout-minimal-header .candidate { bottom: 180px; }
  
  .layout-minimal-footer .footer { height: 30px !important; font-size: 12px; }
  .layout-minimal-footer .slogan { bottom: 45px; }

  /* Footer shapes (inverted header shapes) */
  .footer-wave {
    clip-path: polygon(0 25%, 100% 0, 100% 100%, 0 100%);
  }
  .footer-curve-bottom {
    clip-path: ellipse(100% 85% at 50% 100%);
  }
  .footer-arch {
    clip-path: polygon(0 40%, 50% 0, 100% 40%, 100% 100%, 0 100%);
  }
  .footer-diagonal {
    clip-path: polygon(0 0, 85% 0, 100% 100%, 0 100%);
  }
  .footer-rounded {
    border-radius: 50px 50px 0 0;
  }
  .footer-scoop {
    clip-path: polygon(0 20%, 50% 0, 100% 20%, 100% 100%, 0 100%);
  }
  .footer-mountains {
    clip-path: polygon(0 0, 20% 20%, 40% 0, 60% 20%, 80% 0, 100% 30%, 100% 100%, 0 100%);
  }
  .footer-triangle {
    clip-path: polygon(0 0, 50% 20%, 100% 0, 100% 100%, 0 100%);
  }

  .slogan{
    position:absolute; left:32px; right:32px; bottom:76px;
    background:#ffffffea; border-radius:12px; padding:10px 14px;
    display:flex; justify-content:space-between; align-items:center; gap:16px; border:1px solid #e7e9f4
  }
  .slogan .text{ font-size:22px; font-weight:800 }
  .symbol { width:76px; height:76px; background:#fff; border:2px solid #111; border-radius:10px; object-fit:contain; display:flex; align-items:center; justify-content:center; overflow:hidden }
  .symbol img{ width:100%; height:100%; object-fit:contain }

  .footer{ position:absolute; left:0; right:0; bottom:0; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; color:#fff; font-weight:700; min-height:56px }
  .badge{ background:#ffffff; color:#000; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800 }

  .draggable{ position:absolute; cursor:move; user-select:none; transition: box-shadow 0.2s ease }
  .draggable:hover{ 
    box-shadow: 0 0 0 1px rgba(124,58,237,0.5);
  }
  .draggable.selected{ 
    box-shadow: 0 0 0 2px #7c3aed, 0 0 0 4px rgba(124,58,237,0.2);
    z-index: 1000;
  }
  .resize-handle{ 
    position:absolute; width:12px; height:12px; background:#7c3aed; 
    border:2px solid #fff; border-radius:3px; cursor:nwse-resize;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    opacity: 0.9;
    transition: all 0.2s ease;
    touch-action: none;
  }
  
  @media (max-width: 768px) {
    .resize-handle {
      width: 16px;
      height: 16px;
      border-width: 3px;
    }
  }
  .resize-handle:hover{
    transform: scale(1.2);
    opacity: 1;
    background: #8b5cf6;
  }
  .resize-handle.se{ bottom:-6px; right:-6px; }
  .resize-handle.sw{ bottom:-6px; left:-6px; cursor:nesw-resize; }
  .resize-handle.ne{ top:-6px; right:-6px; cursor:nesw-resize; }
  .resize-handle.nw{ top:-6px; left:-6px; cursor:nwse-resize; }
  .resize-handle.n{ top:-6px; left:50%; transform:translateX(-50%); cursor:ns-resize; }
  .resize-handle.s{ bottom:-6px; left:50%; transform:translateX(-50%); cursor:ns-resize; }
  .resize-handle.e{ right:-6px; top:50%; transform:translateY(-50%); cursor:ew-resize; }
  .resize-handle.w{ left:-6px; top:50%; transform:translateY(-50%); cursor:ew-resize; }
  
  /* Visual indicators for different element types */
  .draggable[contenteditable="true"]{ 
    border: 1px dashed transparent;
  }
  .draggable[contenteditable="true"]:hover{
    border-color: rgba(124,58,237,0.3);
  }
  .draggable[contenteditable="true"].selected{
    border-color: #7c3aed;
  }

  /* Mobile Panel Toggle */
  .mobile-panel-toggle {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1001;
    background: var(--brand);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-family: var(--bangla);
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    touch-action: manipulation;
  }
  
  @media (max-width: 768px) {
    .mobile-panel-toggle {
      display: block !important;
    }
    
    .panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .panel.open {
      transform: translateX(0);
    }
    
    .panel .close-panel {
      position: sticky;
      top: 0;
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      font-family: var(--bangla);
      font-size: 16px;
      margin-bottom: 10px;
    }
  }
  
  @media (min-width: 769px) {
    .mobile-panel-toggle {
      display: none !important;
    }
  }
  
  @media print{
    body{ background:#fff }
    .app{ display:block; padding:0 }
    .panel, .toolbar{ display:none !important }
    .canvas-wrap{ border:0; padding:0; background:none; }
    #poster{ 
      box-shadow:none; 
      transform:none !important;
      width: 794px !important;
      height: 1123px !important;
      max-width: none;
      max-height: none;
    }
    .resize-handle { display: none !important; }
    .draggable.selected { box-shadow: none !important; }
  }
  
  /* High DPI displays */
  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .canvas-wrap {
      background-size: 11px 11px;
    }
  }
</style>
</head>
<body>

<div class="app">
  <!-- Mobile Panel Toggle -->
  <button class="mobile-panel-toggle" id="panelToggle" style="display: none;">
    <span>⚙️</span> কন্ট্রোল প্যানেল
  </button>
  
  <!-- SIDEBAR -->
  <aside class="panel" id="sidebar">
    <h2 data-i18n="settings">পোস্টার সেটিংস</h2>
    <div class="group">
      <div class="row">
        <label data-i18n="size">আকার</label>
        <select id="size">
          <option value="A3-portrait">A3 Portrait</option>
          <option value="A4-portrait" selected>A4 Portrait</option>
          <option value="Square">Square (1080×1080)</option>
        </select>
      </div>
      <div class="row">
        <label data-i18n="lang">ভাষা</label>
        <select id="uiLang">
          <option value="bn" selected>বাংলা</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="row">
        <label data-i18n="primary">প্রাইমারি</label><input type="color" id="cPrimary" value="#136f63">
        <label class="mini" data-i18n="secondary">সেকেন্ডারি</label><input type="color" id="cSecondary" value="#0a9396">
      </div>
      <div class="row">
        <label data-i18n="accent">অ্যাকসেন্ট</label><input type="color" id="cAccent" value="#e63946">
        <label class="mini" data-i18n="text">টেক্সট</label><input type="color" id="cText" value="#11131a">
      </div>
      <div class="chips" id="palette">
        <span class="chip" data-pal="flag">🇧🇩 Flag</span>
        <span class="chip" data-pal="civic">Civic</span>
        <span class="chip" data-pal="youth">Youth</span>
        <span class="chip active" data-pal="classic">Classic</span>
        <span class="chip" data-pal="monochrome">Monochrome</span>
        <span class="chip" data-pal="traditional">Traditional</span>
      </div>
    </div>

    <h2 data-i18n="content">📝 বিষয়বস্তু</h2>
    <div class="group">
      <div class="row"><label data-i18n="party">দল</label><input type="text" id="party" placeholder="দলের নাম" value="দলের নাম" /></div>
      <div class="row"><label data-i18n="candidate">প্রার্থী</label><input type="text" id="candidate" placeholder="প্রার্থীর নাম" value="প্রার্থীর নাম" /></div>
      <div class="row"><label data-i18n="election">নির্বাচন</label><input type="text" id="election" placeholder="জাতীয় নির্বাচন ২০২৬" value="জাতীয় নির্বাচন ২০২৬" /></div>
      <div class="row"><label data-i18n="role">পদ/আসন</label><input type="text" id="role" placeholder="নির্বাচনী এলাকা • ঢাকা-১" value="নির্বাচনী এলাকা • ঢাকা-১" /></div>
      <div class="row"><label data-i18n="slogan">স্লোগান</label><input type="text" id="slogan" placeholder="অগ্রগতি • স্থিতিশীলতা • সমৃদ্ধি" value="অগ্রগতি • স্থিতিশীলতা • সমৃদ্ধি" /></div>
      <div class="row"><label data-i18n="ribbonText">রিবন টেক্সট</label><input type="text" id="ribbonText" placeholder="বাংলাদেশ ২০২৬" value="বাংলাদেশ ২০২৬" /></div>
      <div class="row"><label data-i18n="hashtag">হ্যাশট্যাগ</label><input type="text" id="hashtag" placeholder="#ভোট২০২৬" value="#ভোট২০২৬" /></div>
    </div>

    <h2 data-i18n="media">🖼️ মিডিয়া</h2>
    <div class="group">
      <div class="row"><label data-i18n="partyLogo">দলের লোগো</label><input type="file" id="logo" accept="image/*" /></div>
      <div class="row"><label data-i18n="candidatePhoto">প্রার্থীর ছবি</label><input type="file" id="photo" accept="image/*" /></div>
      <div class="row"><label data-i18n="symbol">প্রতীক</label><input type="file" id="symbol" accept="image/*" /></div>
      <div class="row"><button class="btn" id="clearMedia" type="button" data-i18n="clearMedia">মিডিয়া মুছুন</button></div>
    </div>

    <div class="section-divider" data-title="দ্রুত প্রিসেট"></div>
    
    <div class="quick-actions">
      <h3 data-i18n="presets">🎯 প্রিসেট</h3>
      <div class="chips" id="presets">
        <span class="chip" data-preset="ncp">জাতীয় নাগরিক পার্টি (NCP)</span>
        <span class="chip" data-preset="bnp">বিএনপি</span>
        <span class="chip" data-preset="jatiya">জাতীয় পার্টি</span>
        <span class="chip" data-preset="jamaat">জামায়াত</span>
        <span class="chip" data-preset="mayoral">মেয়র</span>
        <span class="chip" data-preset="parliament">সংসদ</span>
        <span class="chip" data-preset="local">স্থানীয়</span>
        <span class="chip" data-preset="youth">যুব</span>
        <span class="chip" data-preset="women">নারী</span>
        <span class="chip" data-preset="professional">পেশাদার</span>
      </div>
    </div>

    <div class="section-divider" data-title="স্টাইলিং অপশন"></div>
    <div class="group">
      <div class="row" style="gap:6px">
        <button class="btn" id="addText" type="button" data-i18n="addText">টেক্সট যোগ করুন</button>
        <button class="btn" id="addShape" type="button" data-i18n="addShape">আকৃতি যোগ করুন</button>
        <button class="btn" id="addImage" type="button" data-i18n="addImage">ছবি যোগ করুন</button>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn" id="bringFront" type="button" data-i18n="bringFront">সামনে আনুন</button>
        <button class="btn" id="sendBack" type="button" data-i18n="sendBack">পেছনে পাঠান</button>
        <button class="btn warn" id="deleteSel" type="button" data-i18n="delete">মুছুন</button>
      </div>
    </div>

    <h2 data-i18n="textFormat">টেক্সট ফরম্যাট</h2>
    <div class="group">
      <div class="row">
        <label data-i18n="fontFamily">ফন্ট</label>
        <select id="fontFamily">
          <option value="bangla">বাংলা (Noto Sans Bengali)</option>
          <option value="latin">ইংরেজি (Poppins)</option>
          <option value="traditional">ঐতিহ্যবাহী (SolaimanLipi)</option>
          <option value="modern">আধুনিক (Roboto)</option>
        </select>
      </div>
      <div class="row">
        <label data-i18n="fontSize">আকার</label>
        <input type="range" id="fontSize" min="12" max="72" value="24" class="mini">
        <span id="fontSizeDisplay">24px</span>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn" id="boldText" type="button" data-i18n="bold">বোল্ড</button>
        <button class="btn" id="italicText" type="button" data-i18n="italic">ইটালিক</button>
        <button class="btn" id="underlineText" type="button" data-i18n="underline">আন্ডারলাইন</button>
      </div>
    </div>

    <h2 data-i18n="templates">টেমপ্লেট</h2>
    <div class="group">
      <div class="chips" id="templates">
        <span class="chip active" data-tpl="banner">ব্যানার</span>
        <span class="chip" data-tpl="wave">তরঙ্গ</span>
        <span class="chip" data-tpl="diagonal">ডায়াগোনাল</span>
        <span class="chip" data-tpl="minimal">মিনিমাল</span>
        <span class="chip" data-tpl="mesh">মেশ</span>
        <span class="chip" data-tpl="triangles">ত্রিভুজ</span>
        <span class="chip" data-tpl="rays">রশ্মি</span>
        <span class="chip" data-tpl="tiles">টাইলস</span>
        <span class="chip" data-tpl="hexagon">ষড়ভুজ</span>
        <span class="chip" data-tpl="circles">বৃত্ত</span>
        <span class="chip" data-tpl="gradient">গ্রেডিয়েন্ট</span>
        <span class="chip" data-tpl="geometric">জ্যামিতিক</span>
        <span class="chip" data-tpl="stripes">ডোরা</span>
        <span class="chip" data-tpl="diamond">হীরক</span>
        <span class="chip" data-tpl="modern">আধুনিক</span>
        <span class="chip" data-tpl="elegant">মার্জিত</span>
        <span class="chip" data-tpl="traditional">ঐতিহ্যবাহী</span>
        <span class="chip" data-tpl="curved">বক্র</span>
        <span class="chip" data-tpl="monochrome">একরঙা</span>
        <span class="chip" data-tpl="formal">আনুষ্ঠানিক</span>
      </div>
    </div>

    <h2 data-i18n="headerShape">হেডার আকৃতি</h2>
    <div class="group">
      <div class="chips" id="headerShapes">
        <span class="chip active" data-shape="default">সাধারণ</span>
        <span class="chip" data-shape="wave">তরঙ্গ</span>
        <span class="chip" data-shape="curve-bottom">বক্র</span>
        <span class="chip" data-shape="arch">খিলান</span>
        <span class="chip" data-shape="diagonal">তির্যক</span>
        <span class="chip" data-shape="rounded">গোলাকার</span>
        <span class="chip" data-shape="scoop">স্কুপ</span>
        <span class="chip" data-shape="mountains">পাহাড়</span>
        <span class="chip" data-shape="triangle">ত্রিভুজ</span>
      </div>
    </div>

    <h2 data-i18n="layoutSwap">লেআউট সোয়াপ</h2>
    <div class="group">
      <div class="row" style="gap:6px">
        <button class="btn" id="swapHeaderFooter" type="button" data-i18n="swapHeaderFooter">হেডার ⇄ ফুটার</button>
        <button class="btn" id="invertLayout" type="button" data-i18n="invertLayout">উল্টান</button>
      </div>
      <div class="row">
        <label data-i18n="layoutMode">লেআউট মোড</label>
        <select id="layoutMode">
          <option value="normal" selected>স্বাভাবিক</option>
          <option value="inverted">উল্টানো</option>
          <option value="centered">কেন্দ্রীভূত</option>
          <option value="minimal-header">ছোট হেডার</option>
          <option value="minimal-footer">ছোট ফুটার</option>
        </select>
      </div>
    </div>

    <h2 data-i18n="ribbonStyle">রিবন স্টাইল</h2>
    <div class="group">
      <div class="chips" id="ribbonStyles">
        <span class="chip active" data-ribbon="classic">ক্লাসিক</span>
        <span class="chip" data-ribbon="banner">ব্যানার</span>
        <span class="chip" data-ribbon="corner">কোণার</span>
        <span class="chip" data-ribbon="curved">বক্র</span>
        <span class="chip" data-ribbon="badge">ব্যাজ</span>
        <span class="chip" data-ribbon="stamp">স্ট্যাম্প</span>
        <span class="chip" data-ribbon="none">লুকান</span>
      </div>
      <div class="row">
        <label data-i18n="ribbonPosition">অবস্থান</label>
        <select id="ribbonPosition">
          <option value="top-right" selected>উপরে ডানে</option>
          <option value="top-left">উপরে বামে</option>
          <option value="center">মাঝখানে</option>
          <option value="bottom-right">নিচে ডানে</option>
          <option value="bottom-left">নিচে বামে</option>
        </select>
      </div>
    </div>

    <h2 data-i18n="export">📤 এক্সপোর্ট</h2>
    <div class="group">
      <div class="row" style="gap:6px">
        <button class="btn primary block" id="exportPNG" type="button" data-i18n="exportPNG">PNG এক্সপোর্ট</button>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn block" id="exportPDF" type="button" data-i18n="exportPDF">PDF এক্সপোর্ট</button>
      </div>
      <div class="row"><span class="status" id="status">প্রস্তুত।</span></div>
    </div>

    <h2 data-i18n="project">💾 প্রকল্প</h2>
    <div class="group">
      <div class="row" style="gap:6px">
        <button class="btn block" id="saveProject" type="button" data-i18n="saveProject">প্রকল্প সংরক্ষণ</button>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn block" id="loadProject" type="button" data-i18n="loadProject">প্রকল্প লোড</button>
        <input type="file" id="projectFile" accept=".json" style="display:none">
      </div>
      <div class="row" style="gap:6px">
        <button class="btn" id="undo" type="button" data-i18n="undo">↶ আনডু</button>
        <button class="btn" id="redo" type="button" data-i18n="redo">↷ রিডু</button>
      </div>
    </div>
  </aside>

  <!-- STAGE -->
  <section class="stage-wrap">
    <div class="toolbar">
      <div class="chips" id="zoomBar">
        <span class="chip" data-zoom="0.75">75%</span>
        <span class="chip active" data-zoom="1">100%</span>
        <span class="chip" data-zoom="1.25">125%</span>
        <span class="chip" data-zoom="1.5">150%</span>
      </div>
      <div class="spacer"></div>
      <span class="status" id="selectionStatus" data-i18n="noSelection">কিছু নির্বাচিত নয়</span>
      <button class="btn" id="resetLayout" type="button" data-i18n="resetLayout">লেআউট রিসেট</button>
      <button class="btn" id="print" type="button" data-i18n="print">প্রিন্ট</button>
    </div>

    <div class="canvas-wrap">
      <div id="poster" class="A4-portrait" aria-label="Poster Canvas">
        <div class="bg-fill" id="bg"></div>

        <!-- Header -->
        <div class="header draggable" id="header" style="background:linear-gradient(90deg,#136f63,#0a9396)">
          <img class="party-logo" id="partyLogo" alt="">
          <div class="title">
            <div class="party" id="partyText">দলের নাম</div>
            <div class="election" id="electionText">জাতীয় নির্বাচন ২০২৬</div>
          </div>
          <div class="ribbon" id="ribbon">বাংলাদেশ ২০২৬</div>
        </div>

        <!-- Candidate -->
        <div class="candidate draggable" id="candidateBox">
          <img class="photo" id="candidatePhoto" alt="">
          <div class="info">
            <div class="name" id="candidateName">প্রার্থীর নাম</div>
            <div class="role" id="roleText">নির্বাচনী এলাকা • ঢাকা-১</div>
          </div>
        </div>

        <!-- Slogan -->
        <div class="slogan draggable" id="sloganBox">
          <div class="text" id="sloganText">অগ্রগতি • স্থিতিশীলতা • সমৃদ্ধি</div>
          <div class="badge" id="hashtagText">#ভোট২০২৬</div>
          <div class="symbol"><img id="symbolImg" alt=""></div>
        </div>

        <!-- Footer -->
        <div class="footer draggable" id="footer" style="background:linear-gradient(90deg,#0a9396,#136f63)">
          <div id="footerText">নির্বাচন কমিশন অনুবর্তী লেআউট</div>
          <div class="badge" id="siteText">nirbanchon2026.vercel.app</div>
        </div>
      </div>
    </div>

    <div class="toolbar" style="justify-content:flex-end">
      <span class="status">টিপস: যে কোনো উপাদান টেনে আনুন; ক্লিক করে সিলেক্ট করুন; বেগুনি হ্যান্ডল দিয়ে আকার বদলান।</span>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ========= Shortcuts ========= */
const $ = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
const poster = $("#poster");
const ids = {
  party: $("#party"), election: $("#election"), candidate: $("#candidate"),
  role: $("#role"), slogan: $("#slogan"), hashtag: $("#hashtag"), ribbonText: $("#ribbonText"),
  cPrimary: $("#cPrimary"), cSecondary: $("#cSecondary"), cAccent: $("#cAccent"), cText: $("#cText"),
  size: $("#size"), uiLang: $("#uiLang"), ribbonPosition: $("#ribbonPosition"), layoutMode: $("#layoutMode"),
  logo: $("#logo"), photo: $("#photo"), symbol: $("#symbol"),
  partyText: $("#partyText"), electionText: $("#electionText"),
  candidateName: $("#candidateName"), roleText: $("#roleText"),
  sloganText: $("#sloganText"), hashtagText: $("#hashtagText"),
  header: $("#header"), footer: $("#footer"), bg: $("#bg"),
  partyLogo: $("#partyLogo"), candidatePhoto: $("#candidatePhoto"),
  ribbon: $("#ribbon"), sloganBox: $("#sloganBox"), candidateBox: $("#candidateBox"),
  symbolImg: $("#symbolImg"), status: $("#status")
};
    // Mobile Panel Functions
    function toggleMobilePanel() {
      const panel = document.querySelector('.panel');
      panel.classList.toggle('open');
      document.body.style.overflow = panel.classList.contains('open') ? 'hidden' : '';
    }

    function closeMobilePanel() {
      const panel = document.querySelector('.panel');
      panel.classList.remove('open');
      document.body.style.overflow = '';
    }

    // Dynamic Poster Scaling
    function scalePosterForMobile() {
      const canvas = document.getElementById('canvas');
      const container = document.querySelector('.canvas-container');
      
      if (window.innerWidth <= 768) {
        const scale = Math.min(
          (window.innerWidth - 40) / 800,
          (window.innerHeight * 0.6) / 600
        );
        canvas.style.transform = `scale(${scale})`;
        canvas.style.transformOrigin = 'top left';
        container.style.width = `${800 * scale}px`;
        container.style.height = `${600 * scale}px`;
      } else {
        canvas.style.transform = '';
        canvas.style.transformOrigin = '';
        container.style.width = '';
        container.style.height = '';
      }
    }

    // Initialize mobile functionality
    window.addEventListener('resize', scalePosterForMobile);
    document.addEventListener('DOMContentLoaded', () => {
      scalePosterForMobile();
      
      // Setup panel toggle events
      const toggleBtn = document.querySelector('.mobile-panel-toggle');
      const closeBtn = document.querySelector('.close-panel');
      
      if (toggleBtn) toggleBtn.addEventListener('click', toggleMobilePanel);
      if (closeBtn) closeBtn.addEventListener('click', closeMobilePanel);
    });

    // Collapsible Section Functionality
    function toggleSection(headerElement) {
      const content = headerElement.nextElementSibling;
      const toggle = headerElement.querySelector('.section-toggle');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        toggle.classList.remove('collapsed');
        // Save state to localStorage
        localStorage.setItem('section_' + headerElement.textContent.trim(), 'open');
      } else {
        content.classList.add('collapsed');
        toggle.classList.add('collapsed');
        // Save state to localStorage
        localStorage.setItem('section_' + headerElement.textContent.trim(), 'closed');
      }
    }

    // Restore section states on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.section-header').forEach(header => {
        const sectionKey = 'section_' + header.textContent.trim();
        const state = localStorage.getItem(sectionKey);
        const content = header.nextElementSibling;
        const toggle = header.querySelector('.section-toggle');
        
        if (state === 'closed') {
          content.classList.add('collapsed');
          toggle.classList.add('collapsed');
        } else if (state === 'open') {
          content.classList.remove('collapsed');
          toggle.classList.remove('collapsed');
        }
      });
    });

    function setStatus(msg){ ids.status.textContent=msg; setTimeout(()=>ids.status.textContent=(ids.uiLang.value==="bn"?"প্রস্তুত।":"Ready."), 2000); }/* ========= Size / Zoom ========= */
ids.size.addEventListener("change", e=>{
  poster.classList.remove("A4-portrait","A3-portrait","Square");
  poster.classList.add(e.target.value);
  poster.style.transform = "";
});
$("#zoomBar").addEventListener("click", e=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#zoomBar .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  const z = parseFloat(chip.dataset.zoom||"1");
  poster.style.transform = `scale(${z})`;
  poster.style.transformOrigin = "top center";
});

/* ========= Palette ========= */
$("#palette").addEventListener("click", e=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#palette .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  const sets = {
    flag:        ["#006a4e","#da291c","#ffc300","#11131a"],
    civic:       ["#1d3557","#457b9d","#e63946","#11131a"],
    youth:       ["#0ea5e9","#22c55e","#a855f7","#0f172a"],
    classic:     ["#0b3d2e","#1e847f","#eec643","#222222"],
    monochrome:  ["#000000","#333333","#666666","#ffffff"],
    traditional: ["#8b0000","#000000","#ffd700","#ffffff"],
  };
  const [p,s,a,t] = sets[chip.dataset.pal] || sets.flag;
  ids.cPrimary.value=p; ids.cSecondary.value=s; ids.cAccent.value=a; ids.cText.value=t;
  applyColors(); randomRibbon(); buildBaseBG(); applyBG();
});
["cPrimary","cSecondary","cAccent","cText"].forEach(id=>{
  ids[id].addEventListener("input", ()=>{ applyColors(); randomRibbon(); buildBaseBG(); applyBG(); });
});

/* ========= Colors ========= */
function applyColors(){
  const p = ids.cPrimary.value, s = ids.cSecondary.value, a=ids.cAccent.value, t=ids.cText.value;
  ids.header.style.background = `linear-gradient(90deg, ${p}, ${s})`;
  ids.footer.style.background = `linear-gradient(90deg, ${s}, ${p})`;
  ids.partyText.style.color = "#fff";
  ids.electionText.style.color = "#fff";
  ids.candidateName.style.color = t;
  ids.roleText.style.color = "#3b3f4c";
  ids.sloganText.style.color = "#0b1320";
  ids.hashtagText.style.background = a; ids.hashtagText.style.color = "#fff";
}

/* ========= Abstract BG engine (base + overlay) ========= */
let BG_BASE = "", BG_OVERLAY = "";
function svgEncode(s){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(s); }
function buildBaseBG(){
  const p = ids.cPrimary.value, s = ids.cSecondary.value, a = ids.cAccent.value;
  const seed = Math.floor(Math.random()*9999);
  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="2200" viewBox="0 0 1600 2200">
  <defs>
    <filter id="noise">
      <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="${seed}" result="t" />
      <feColorMatrix type="saturate" values="0.25"/>
      <feComponentTransfer>
        <feFuncA type="table" tableValues="0 0.07"/>
      </feComponentTransfer>
    </filter>
    <radialGradient id="rg1" cx="18%" cy="12%" r="58%">
      <stop offset="0%" stop-color="${p}" stop-opacity="0.18"/>
      <stop offset="100%" stop-color="${p}" stop-opacity="0"/>
    </radialGradient>
    <radialGradient id="rg2" cx="82%" cy="10%" r="55%">
      <stop offset="0%" stop-color="${s}" stop-opacity="0.18"/>
      <stop offset="100%" stop-color="${s}" stop-opacity="0"/>
    </radialGradient>
    <radialGradient id="rg3" cx="50%" cy="92%" r="62%">
      <stop offset="0%" stop-color="${a}" stop-opacity="0.14"/>
      <stop offset="100%" stop-color="${a}" stop-opacity="0"/>
    </radialGradient>
  </defs>
  <rect width="100%" height="100%" fill="#ffffff"/>
  <rect width="100%" height="100%" filter="url(#noise)"/>
  <rect width="100%" height="100%" fill="url(#rg1)"/>
  <rect width="100%" height="100%" fill="url(#rg2)"/>
  <rect width="100%" height="100%" fill="url(#rg3)"/>
</svg>`;
  const url = svgEncode(svg);
  // base layers (bottom-most last)
  BG_BASE = `
    url("${url}") center/cover no-repeat,
    radial-gradient(120% 80% at 0% 0%, ${p}20 0%, #fff 60%),
    radial-gradient(120% 80% at 100% 0%, ${s}20 0%, #fff 60%),
    linear-gradient(#fff, #fff)
  `.trim();
}
function setTemplateOverlay(name){
  const p = ids.cPrimary.value, s = ids.cSecondary.value, a=ids.cAccent.value;
  const overlays = {
    banner:   `linear-gradient(180deg, #ffffff00 0%, #ffffffaa 40%, ${p}12 100%)`,
    wave:     `radial-gradient(120% 60% at -10% 0%, ${p}33 0%, #fff0 60%), radial-gradient(100% 50% at 110% 0%, ${s}33 0%, #fff0 60%)`,
    diagonal: `linear-gradient(135deg, ${p}18 0%, #fff0 45%, #fff0 55%, ${s}18 100%)`,
    minimal:  ``,
    mesh:     `radial-gradient(40% 50% at 15% 10%, ${p}22, transparent),
               radial-gradient(50% 60% at 85% 20%, ${s}22, transparent),
               radial-gradient(35% 45% at 50% 90%, ${a}18, transparent)`,
    triangles:`repeating-linear-gradient(60deg, ${p}14 0 18px, transparent 18px 36px),
               repeating-linear-gradient(-60deg, ${s}14 0 18px, transparent 18px 36px)`,
    rays:     `conic-gradient(from 180deg at 50% 20%, ${p}14, #fff0 20%, ${s}14 40%, #fff0 60%, ${a}14 80%, #fff0 100%)`,
    tiles:    `repeating-conic-gradient(from 45deg, ${p}12 0 12deg, ${s}10 12deg 24deg, #ffffff00 24deg 36deg)`,
    hexagon:  `radial-gradient(circle at 25% 25%, ${p}20 0%, transparent 50%),
               radial-gradient(circle at 75% 25%, ${s}20 0%, transparent 50%),
               radial-gradient(circle at 50% 75%, ${a}15 0%, transparent 50%)`,
    circles:  `radial-gradient(circle at 20% 20%, ${p}25, transparent 35%),
               radial-gradient(circle at 80% 30%, ${s}25, transparent 35%),
               radial-gradient(circle at 60% 80%, ${a}20, transparent 30%)`,
    gradient: `linear-gradient(45deg, ${p}08 0%, ${s}12 50%, ${a}08 100%)`,
    geometric:`polygon(0 0, 100% 0, 85% 100%, 0 100%) linear-gradient(120deg, ${p}15, transparent),
               polygon(15% 0, 100% 0, 100% 100%, 0 100%) linear-gradient(240deg, ${s}15, transparent)`,
    stripes:  `repeating-linear-gradient(45deg, ${p}18 0, ${p}18 20px, transparent 20px, transparent 40px),
               repeating-linear-gradient(-45deg, ${s}15 0, ${s}15 15px, transparent 15px, transparent 30px)`,
    diamond:  `repeating-conic-gradient(from 0deg at 50% 50%, ${p}18 0deg 45deg, transparent 45deg 90deg, ${s}18 90deg 135deg, transparent 135deg 180deg)`,
    modern:   `radial-gradient(ellipse 80% 50% at 50% 0%, ${p}20, transparent),
               linear-gradient(180deg, transparent 60%, ${s}12 100%)`,
    elegant:  `linear-gradient(135deg, ${p}05 0%, transparent 25%, ${s}08 50%, transparent 75%, ${a}05 100%),
               radial-gradient(circle at 80% 20%, ${p}12, transparent 40%)`,
    traditional: `linear-gradient(180deg, ${p}15 0%, transparent 30%),
                  radial-gradient(ellipse 120% 40% at 50% 100%, ${s}12, transparent),
                  linear-gradient(0deg, ${p}08 0%, transparent 20%)`,
    curved:   `radial-gradient(ellipse 150% 60% at 50% 0%, ${p}18, transparent),
               radial-gradient(ellipse 120% 50% at 0% 100%, ${s}15, transparent),
               radial-gradient(ellipse 120% 50% at 100% 100%, ${a}12, transparent)`,
    monochrome: `linear-gradient(45deg, ${p}20 0%, transparent 30%, ${s}15 70%, transparent 100%)`,
    formal:   `linear-gradient(180deg, ${p}12 0%, transparent 25%, transparent 75%, ${s}10 100%),
               radial-gradient(circle at 25% 25%, ${a}08, transparent 50%)`
  };
  BG_OVERLAY = (overlays[name] || "").replace(/\s+/g,' ').trim();
}
function applyBG(){
  // if overlay present, it should be top-most (first)
  ids.bg.style.background = BG_OVERLAY ? `${BG_OVERLAY}, ${BG_BASE}` : BG_BASE;
}

/* ========= Project Management ========= */
let projectHistory = [];
let historyIndex = -1;
const maxHistory = 20;

function saveState() {
  const state = {
    party: ids.party.value,
    election: ids.election.value,
    candidate: ids.candidate.value,
    role: ids.role.value,
    slogan: ids.slogan.value,
    ribbonText: ids.ribbonText.value,
    hashtag: ids.hashtag.value,
    colors: {
      primary: ids.cPrimary.value,
      secondary: ids.cSecondary.value,
      accent: ids.cAccent.value,
      text: ids.cText.value
    },
    size: ids.size.value,
    template: document.querySelector('#templates .chip.active')?.dataset.tpl || 'banner',
    headerShape: document.querySelector('#headerShapes .chip.active')?.dataset.shape || 'default',
    ribbonStyle: document.querySelector('#ribbonStyles .chip.active')?.dataset.ribbon || 'classic',
    ribbonPosition: ids.ribbonPosition.value,
    layoutMode: ids.layoutMode.value
  };
  
  // Remove future history if we're not at the end
  if (historyIndex < projectHistory.length - 1) {
    projectHistory = projectHistory.slice(0, historyIndex + 1);
  }
  
  projectHistory.push(JSON.stringify(state));
  if (projectHistory.length > maxHistory) {
    projectHistory.shift();
  } else {
    historyIndex++;
  }
}

function loadState(stateStr) {
  const state = JSON.parse(stateStr);
  
  ids.party.value = state.party || '';
  ids.election.value = state.election || '';
  ids.candidate.value = state.candidate || '';
  ids.role.value = state.role || '';
  ids.slogan.value = state.slogan || '';
  ids.ribbonText.value = state.ribbonText || '';
  ids.hashtag.value = state.hashtag || '';
  
  if(state.colors) {
    ids.cPrimary.value = state.colors.primary || '#136f63';
    ids.cSecondary.value = state.colors.secondary || '#0a9396';
    ids.cAccent.value = state.colors.accent || '#e63946';
    ids.cText.value = state.colors.text || '#11131a';
  }
  
  ids.size.value = state.size || 'A4-portrait';
  ids.ribbonPosition.value = state.ribbonPosition || 'top-right';
  ids.layoutMode.value = state.layoutMode || 'normal';
  
  // Trigger updates
  ids.party.dispatchEvent(new Event('input'));
  ids.election.dispatchEvent(new Event('input'));
  ids.candidate.dispatchEvent(new Event('input'));
  ids.role.dispatchEvent(new Event('input'));
  ids.slogan.dispatchEvent(new Event('input'));
  ids.ribbonText.dispatchEvent(new Event('input'));
  ids.hashtag.dispatchEvent(new Event('input'));
  
  applyColors();
  
  // Apply template
  if(state.template) {
    document.querySelectorAll('#templates .chip').forEach(c => c.classList.remove('active'));
    document.querySelector(`#templates .chip[data-tpl='${state.template}']`)?.classList.add('active');
  }
  
  // Apply other settings...
}

$("#saveProject").addEventListener("click", ()=>{
  saveState();
  const currentState = projectHistory[historyIndex];
  const blob = new Blob([currentState], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `election-poster-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  setStatus(ids.uiLang.value==="bn" ? "প্রকল্প সংরক্ষিত" : "Project saved");
});

$("#loadProject").addEventListener("click", ()=>{
  ids.projectFile = document.querySelector('#projectFile');
  ids.projectFile.click();
});

document.querySelector('#projectFile').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    try {
      loadState(reader.result);
      setStatus(ids.uiLang.value==="bn" ? "প্রকল্প লোড হয়েছে" : "Project loaded");
    } catch(err) {
      setStatus(ids.uiLang.value==="bn" ? "লোড ত্রুটি" : "Load error");
    }
  };
  reader.readAsText(file);
});

$("#undo").addEventListener("click", ()=>{
  if(historyIndex > 0) {
    historyIndex--;
    loadState(projectHistory[historyIndex]);
    setStatus(ids.uiLang.value==="bn" ? "আনডু" : "Undo");
  }
});

$("#redo").addEventListener("click", ()=>{
  if(historyIndex < projectHistory.length - 1) {
    historyIndex++;
    loadState(projectHistory[historyIndex]);
    setStatus(ids.uiLang.value==="bn" ? "রিডু" : "Redo");
  }
});

// Auto-save state on major changes
['party', 'election', 'candidate', 'role', 'slogan', 'ribbonText', 'hashtag'].forEach(field => {
  ids[field].addEventListener('input', () => {
    clearTimeout(window.autoSaveTimeout);
    window.autoSaveTimeout = setTimeout(saveState, 1000);
  });
});

/* ========= Layout Swap ========= */
let isLayoutSwapped = false;

$("#swapHeaderFooter").addEventListener("click", ()=>{
  // Simple position swap without changing content structure
  poster.classList.toggle("layout-swapped");
  isLayoutSwapped = !isLayoutSwapped;
  
  setStatus(ids.uiLang.value==="bn" ? 
    (isLayoutSwapped ? "হেডার ও ফুটার সোয়াপ হয়েছে" : "লেআউট পুনরুদ্ধার হয়েছে") : 
    (isLayoutSwapped ? "Header and Footer swapped" : "Layout restored"));
});

$("#invertLayout").addEventListener("click", ()=>{
  poster.classList.toggle("layout-inverted");
  setStatus(ids.uiLang.value==="bn" ? "লেআউট উল্টানো হয়েছে" : "Layout inverted");
});

ids.layoutMode.addEventListener("change", e=>{
  const mode = e.target.value;
  
  // Remove all layout classes
  const layoutClasses = ["layout-inverted", "layout-centered", "layout-minimal-header", "layout-minimal-footer"];
  layoutClasses.forEach(cls => poster.classList.remove(cls));
  
  // Apply selected layout
  if(mode !== "normal") {
    poster.classList.add(`layout-${mode}`);
  }
});

/* ========= Text Formatting ========= */
$("#fontSize").addEventListener("input", e=>{
  const size = e.target.value;
  document.querySelector('#fontSizeDisplay').textContent = size + 'px';
  if(selected && selected.tagName === 'DIV' && selected.contentEditable === 'true') {
    selected.style.fontSize = size + 'px';
  }
});

$("#fontFamily").addEventListener("change", e=>{
  const family = e.target.value;
  const fontMap = {
    bangla: 'var(--bangla)',
    latin: 'var(--latin)',
    traditional: '"SolaimanLipi", var(--bangla)',
    modern: '"Roboto", var(--latin)'
  };
  if(selected && selected.tagName === 'DIV' && selected.contentEditable === 'true') {
    selected.style.fontFamily = fontMap[family] || 'var(--bangla)';
  }
});

$("#boldText").addEventListener("click", ()=>{
  if(selected && selected.tagName === 'DIV' && selected.contentEditable === 'true') {
    const current = selected.style.fontWeight;
    selected.style.fontWeight = current === '700' || current === 'bold' ? 'normal' : 'bold';
  }
});

$("#italicText").addEventListener("click", ()=>{
  if(selected && selected.tagName === 'DIV' && selected.contentEditable === 'true') {
    const current = selected.style.fontStyle;
    selected.style.fontStyle = current === 'italic' ? 'normal' : 'italic';
  }
});

$("#underlineText").addEventListener("click", ()=>{
  if(selected && selected.tagName === 'DIV' && selected.contentEditable === 'true') {
    const current = selected.style.textDecoration;
    selected.style.textDecoration = current === 'underline' ? 'none' : 'underline';
  }
});

/* ========= Presets ========= */
$("#presets").addEventListener("click", e=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#presets .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  
  const presets = {
    // Major Political Parties
    ncp: {
      party: "জাতীয় নাগরিক পার্টি (NCP)",
      election: "জাতীয় সংসদ নির্বাচন ২০২৬",
      candidate: "প্রার্থীর নাম",
      role: "নির্বাচনী এলাকা • ঢাকা-১",
      slogan: "উন্নয়ন • অগ্রগতি • সমৃদ্ধির বাংলাদেশ",
      ribbonText: "National Citizen Party",
      hashtag: "#ভোট২০২৬",
      template: "modern",
      colors: ["#006A4E", "#0F9D58", "#F1C40F", "#000000"]
    },
    bnp: {
      party: "বাংলাদেশ জাতীয়তাবাদী দল",
      election: "জাতীয় সংসদ নির্বাচন ২০২৬",
      candidate: "প্রার্থীর নাম",
      role: "নির্বাচনী এলাকা • ঢাকা-১",
      slogan: "গণতন্ত্র • ন্যায়বিচার • মানুষের অধিকার",
      ribbonText: "বিএনপি",
      hashtag: "#BNP2026",
      template: "traditional",
      colors: ["#228B22", "#32CD32", "#FFD700", "#000000"]
    },
    jatiya: {
      party: "জাতীয় পার্টি (জেপি)",
      election: "জাতীয় সংসদ নির্বাচন ২০২৬",
      candidate: "প্রার্থীর নাম",
      role: "নির্বাচনী এলাকা • ঢাকা-১",
      slogan: "জনগণের কল্যাণ • জাতীয় ঐক্য • উন্নয়ন",
      ribbonText: "জাতীয় পার্টি",
      hashtag: "#JP2026",
      template: "geometric",
      colors: ["#FF6B35", "#F7931E", "#1E90FF", "#000000"]
    },
    jamaat: {
      party: "বাংলাদেশ জামায়াতে ইসলামী",
      election: "জাতীয় সংসদ নির্বাচন ২০২৬",
      candidate: "প্রার্থীর নাম",
      role: "নির্বাচনী এলাকা • ঢাকা-১",
      slogan: "ইসলামী মূল্যবোধ • ন্যায়বিচার • সুশাসন",
      ribbonText: "জামায়াত",
      hashtag: "#Jamaat2026",
      template: "banner",
      colors: ["#006633", "#009966", "#FFFFFF", "#000000"]
    },
    mayoral: {
      party: "নগর উন্নয়ন দল",
      election: "মেয়র নির্বাচন ২০২৬",
      candidate: "মেয়র প্রার্থী",
      role: "ঢাকা উত্তর সিটি কর্পোরেশন",
      slogan: "স্মার্ট সিটি • পরিচ্ছন্ন পরিবেশ • উন্নত জীবন",
      ribbonText: "মেয়র২০২৬",
      hashtag: "#SmartCity",
      template: "modern",
      colors: ["#1e40af", "#3b82f6", "#f59e0b", "#1f2937"]
    },
    parliament: {
      party: "জাতীয় ঐক্য দল",
      election: "জাতীয় সংসদ নির্বাচন ২০২৬",
      candidate: "সংসদ সদস্য প্রার্থী",
      role: "নির্বাচনী এলাকা • ঢাকা-৫",
      slogan: "জনগণের সেবা • দেশের উন্নতি • ভবিষ্যতের আশা",
      ribbonText: "সংসদ২০২৬",
      hashtag: "#Parliament2026",
      template: "traditional",
      colors: ["#059669", "#10b981", "#dc2626", "#111827"]
    },
    local: {
      party: "স্থানীয় সেবা দল",
      election: "স্থানীয় সরকার নির্বাচন ২০২৬",
      candidate: "স্থানীয় প্রতিনিধি",
      role: "ইউনিয়ন পরিষদ • চেয়ারম্যান",
      slogan: "গ্রামের উন্নয়ন • জনসেবা • স্বচ্ছতা",
      ribbonText: "স্থানীয়২০২৬",
      hashtag: "#LocalGov2026",
      template: "gradient",
      colors: ["#16a085", "#1abc9c", "#e74c3c", "#2c3e50"]
    },
    youth: {
      party: "যুব শক্তি আন্দোলন",
      election: "যুব নেতৃত্ব নির্বাচন ২০২৬",
      candidate: "যুব নেতা",
      role: "তরুণ প্রজন্মের প্রতিনিধি",
      slogan: "নতুন চিন্তা • নতুন নেতৃত্ব • নতুন বাংলাদেশ",
      ribbonText: "যুব২০২৬",
      hashtag: "#YouthPower",
      template: "modern",
      colors: ["#7c3aed", "#a855f7", "#f97316", "#0f172a"]
    },
    women: {
      party: "নারী ক্ষমতায়ন দল",
      election: "নারী নেতৃত্ব নির্বাচন ২০২৬",
      candidate: "নারী নেত্রী",
      role: "নারী প্রতিনিধি • সংরক্ষিত আসন",
      slogan: "নারীর ক্ষমতায়ন • সমান অধিকার • উন্নত সমাজ",
      ribbonText: "নারীশক্তি",
      hashtag: "#WomenPower",
      template: "geometric",
      colors: ["#ec4899", "#f472b6", "#8b5cf6", "#1f2937"]
    },
    professional: {
      party: "পেশাদার ঐক্য ফোরাম",
      election: "পেশাদার প্রতিনিধি নির্বাচন ২০২৬",
      candidate: "পেশাদার প্রতিনিধি",
      role: "ডাক্তার/ইঞ্জিনিয়ার/শিক্ষক সমিতি",
      slogan: "পেশাদারিত্ব • দক্ষতা • সেবার মানসিকতা",
      ribbonText: "পেশাদার২০২৬",
      hashtag: "#Professional",
      template: "banner",
      colors: ["#0ea5e9", "#38bdf8", "#f59e0b", "#374151"]
    }
  };
  
  const preset = presets[chip.dataset.preset];
  if(preset) {
    ids.party.value = preset.party;
    ids.election.value = preset.election;
    ids.candidate.value = preset.candidate;
    ids.role.value = preset.role;
    ids.slogan.value = preset.slogan;
    if(preset.ribbonText) ids.ribbonText.value = preset.ribbonText;
    if(preset.hashtag) ids.hashtag.value = preset.hashtag;
    
    // Apply colors
    ids.cPrimary.value = preset.colors[0];
    ids.cSecondary.value = preset.colors[1];
    ids.cAccent.value = preset.colors[2];
    ids.cText.value = preset.colors[3];
    
    // Apply template
    $$("#templates .chip").forEach(c=>c.classList.remove("active"));
    $(`#templates .chip[data-tpl='${preset.template}']`).classList.add("active");
    
    // Trigger updates for all fields
    ['party', 'election', 'candidate', 'role', 'slogan', 'ribbonText', 'hashtag'].forEach(field => {
      if(ids[field]) {
        ids[field].dispatchEvent(new Event('input'));
      }
    });
    
    applyColors();
    setTemplateOverlay(preset.template);
    applyBG();
    
    // Update ribbon and hashtag text immediately
    if(preset.ribbonText && ids.ribbon) ids.ribbon.textContent = preset.ribbonText;
    if(preset.hashtag && ids.hashtagText) ids.hashtagText.textContent = preset.hashtag;
    
    setStatus(ids.uiLang.value==="bn" ? "প্রিসেট প্রয়োগ হয়েছে: " + preset.party : "Preset applied: " + preset.party);
    saveState();
  }
});

/* ========= Ribbon Styles ========= */
$("#ribbonStyles").addEventListener("click", e=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#ribbonStyles .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  const style = chip.dataset.ribbon;
  
  // Remove all ribbon style classes
  const ribbonClasses = ["ribbon-classic", "ribbon-banner", "ribbon-corner", "ribbon-curved", "ribbon-badge", "ribbon-stamp", "ribbon-hidden"];
  ribbonClasses.forEach(cls => ids.ribbon.classList.remove(cls));
  
  // Apply new ribbon style
  if(style === "none") {
    ids.ribbon.classList.add("ribbon-hidden");
  } else {
    ids.ribbon.classList.add(`ribbon-${style}`);
  }
  
  // Reapply position
  applyRibbonPosition();
});

ids.ribbonPosition.addEventListener("change", applyRibbonPosition);

function applyRibbonPosition(){
  const pos = ids.ribbonPosition.value;
  const posClasses = ["ribbon-pos-top-left", "ribbon-pos-center", "ribbon-pos-bottom-right", "ribbon-pos-bottom-left"];
  posClasses.forEach(cls => ids.ribbon.classList.remove(cls));
  
  if(pos !== "top-right") {
    ids.ribbon.classList.add(`ribbon-pos-${pos}`);
  }
}

/* ========= Header Shapes ========= */
$("#headerShapes").addEventListener("click", e=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#headerShapes .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  const shape = chip.dataset.shape;
  
  // Remove all header and footer shape classes
  const shapeClasses = ["header-wave", "header-curve-bottom", "header-arch", "header-diagonal", "header-rounded", "header-scoop", "header-mountains", "header-triangle"];
  const footerShapeClasses = ["footer-wave", "footer-curve-bottom", "footer-arch", "footer-diagonal", "footer-rounded", "footer-scoop", "footer-mountains", "footer-triangle"];
  
  shapeClasses.forEach(cls => ids.header.classList.remove(cls));
  footerShapeClasses.forEach(cls => ids.footer.classList.remove(cls));
  
  // Apply shape to header (shapes will adapt based on layout)
  if(shape !== "default") {
    ids.header.classList.add(`header-${shape}`);
  }
});

/* ========= Templates ========= */
$("#templates").addEventListener("click", e=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#templates .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  const tpl = chip.dataset.tpl;

  // Section geometry tweaks per template
  $("#header").style.height = "30%";
  $(".footer").style.height = "56px";
  $("#candidateBox").style.bottom = "220px";
  $("#sloganBox").style.bottom = "76px";
  
  // Template-specific layout adjustments
  if(tpl==="minimal"){
    $("#header").style.height = "22%";
    $("#candidateBox").style.bottom = "170px";
    $("#sloganBox").style.bottom = "40px";
  } else if(tpl==="modern" || tpl==="elegant"){
    $("#header").style.height = "35%";
    $("#candidateBox").style.bottom = "230px";
    $("#sloganBox").style.bottom = "80px";
  } else if(tpl==="geometric" || tpl==="diamond"){
    $("#header").style.height = "28%";
    $("#candidateBox").style.bottom = "210px";
    $("#sloganBox").style.bottom = "70px";
  } else if(tpl==="gradient" || tpl==="circles"){
    $("#header").style.height = "32%";
    $("#candidateBox").style.bottom = "225px";
    $("#sloganBox").style.bottom = "78px";
  } else if(tpl==="hexagon" || tpl==="stripes"){
    $("#header").style.height = "29%";
    $("#candidateBox").style.bottom = "215px";
    $("#sloganBox").style.bottom = "74px";
  } else if(tpl==="traditional" || tpl==="formal"){
    $("#header").style.height = "26%";
    $("#candidateBox").style.bottom = "200px";
    $("#sloganBox").style.bottom = "65px";
  } else if(tpl==="curved"){
    $("#header").style.height = "33%";
    $("#candidateBox").style.bottom = "235px";
    $("#sloganBox").style.bottom = "85px";
  } else if(tpl==="monochrome"){
    $("#header").style.height = "28%";
    $("#candidateBox").style.bottom = "210px";
    $("#sloganBox").style.bottom = "70px";
  }

  setTemplateOverlay(tpl);
  randomRibbon();
  applyBG();
  
  // Apply special styling for certain templates
  if(tpl === "traditional" || tpl === "formal"){
    poster.classList.add("formal-border");
    // Make text more bold and formal
    ids.candidateName.style.fontWeight = "900";
    ids.candidateName.style.textShadow = "2px 2px 4px rgba(0,0,0,0.3)";
  } else {
    poster.classList.remove("formal-border");
    ids.candidateName.style.fontWeight = "900";
    ids.candidateName.style.textShadow = "";
  }
  
  // Special handling for monochrome template
  if(tpl === "monochrome"){
    ids.candidateName.style.color = "#000";
    ids.roleText.style.color = "#333";
    ids.sloganText.style.color = "#000";
  }
});

/* ========= Ribbon random styles ========= */
const RIBBON_STYLES = [
  (a) => `linear-gradient(135deg, ${a}, ${a}cc)`,
  (a) => `repeating-linear-gradient(45deg, ${a}, ${a} 10px, #ffffff 10px, #ffffff 20px)`,
  (a) => `radial-gradient(circle at center, ${a}, ${a}aa)`,
  (a) => `${a}`,
  (a) => `conic-gradient(from 45deg, ${a}cc, ${a}, ${a}dd)`
];
function randomRibbon(){
  const a = ids.cAccent.value;
  const styleFn = RIBBON_STYLES[Math.floor(Math.random()*RIBBON_STYLES.length)];
  ids.ribbon.style.background = styleFn(a);
  ids.ribbon.style.color = "#fff";
}

/* ========= Content binding ========= */
ids.party.addEventListener("input", e=> ids.partyText.textContent = e.target.value||"");
ids.election.addEventListener("input", e=> ids.electionText.textContent = e.target.value||"");
ids.candidate.addEventListener("input", e=> ids.candidateName.textContent = e.target.value||"");
ids.role.addEventListener("input", e=> ids.roleText.textContent = e.target.value||"");
ids.slogan.addEventListener("input", e=> ids.sloganText.textContent = e.target.value||"");
ids.ribbonText.addEventListener("input", e=> ids.ribbon.textContent = e.target.value||"");
ids.hashtag.addEventListener("input", e=> ids.hashtagText.textContent = e.target.value||"");

/* ========= Media ========= */
function loadImage(file, imgEl){
  if(!file) return (imgEl.removeAttribute("src"), void 0);
  const r = new FileReader();
  r.onload = ()=> imgEl.src = r.result;
  r.readAsDataURL(file);
}
ids.logo.addEventListener("change", e=> loadImage(e.target.files[0], ids.partyLogo));
ids.photo.addEventListener("change", e=> loadImage(e.target.files[0], ids.candidatePhoto));
ids.symbol.addEventListener("change", e=> loadImage(e.target.files[0], ids.symbolImg));
$("#clearMedia").addEventListener("click", ()=>{
  ids.logo.value=""; ids.photo.value=""; ids.symbol.value="";
  ids.partyLogo.removeAttribute("src"); ids.candidatePhoto.removeAttribute("src"); ids.symbolImg.removeAttribute("src");
});

/* ========= Drag / Resize System ========= */

function select(el){
  // Clear previous selection completely
  if(selected && selected !== el){ 
    selected.classList.remove("selected"); 
    // Remove all resize handles
    const handles = selected.querySelectorAll(".resize-handle");
    handles.forEach(h => h.remove());
  }
  
  // Set new selection
  selected = el;
  
  // Update status display
  const statusEl = $("#selectionStatus");
  if(!selected) {
    statusEl.textContent = ids.uiLang.value === "bn" ? "কিছু নির্বাচিত নয়" : "Nothing selected";
    return;
  }
  
  // Show what's selected
  let name = "Unknown";
  if(selected.id === "header") name = ids.uiLang.value === "bn" ? "হেডার" : "Header";
  else if(selected.id === "footer") name = ids.uiLang.value === "bn" ? "ফুটার" : "Footer"; 
  else if(selected.id === "candidateBox") name = ids.uiLang.value === "bn" ? "প্রার্থী" : "Candidate";
  else if(selected.id === "sloganBox") name = ids.uiLang.value === "bn" ? "স্লোগান" : "Slogan";
  else if(selected.id === "ribbon") name = ids.uiLang.value === "bn" ? "ফিতা" : "Ribbon";
  else if(selected.contentEditable === "true") name = ids.uiLang.value === "bn" ? "টেক্সট" : "Text";
  else if(selected.tagName === "IMG") name = ids.uiLang.value === "bn" ? "ছবি" : "Image";
  else name = ids.uiLang.value === "bn" ? "আকৃতি" : "Shape";
  
  statusEl.textContent = (ids.uiLang.value === "bn" ? "নির্বাচিত: " : "Selected: ") + name;
  
  // Add selection styling
  selected.classList.add("selected");
  
  // Add resize handles only if they don't exist
  if(!selected.querySelector(".resize-handle")){
    const handles = ['nw','n','ne','w','e','sw','s','se'];
    handles.forEach(pos=>{
      const h = document.createElement("div");
      h.className = `resize-handle ${pos}`;
      h.dataset.resize = pos;
      h.style.pointerEvents = "auto"; // Ensure handles are clickable
      selected.appendChild(h);
    });
  }
  
  // Force a small delay to ensure handles are properly added
  setTimeout(() => {
    if(selected) {
      selected.style.zIndex = "100"; // Bring selected element to front
    }
  }, 10);
}

/* ========= Drag / Resize System ========= */
let selected = null, dragOff=[0,0], resizeMode=null, resizeStart={w:0,h:0,x:0,y:0}, isDragging=false;

function makeDraggable(el){
  if(!el) return;
  el.classList.add('draggable');
  // Don't add individual event listeners anymore - use event delegation
}

function dragMove(e){
  if(!selected || resizeMode || !isDragging) return;
  
  e.preventDefault();
  const pr = poster.getBoundingClientRect();
  let x = e.clientX - pr.left - dragOff[0];
  let y = e.clientY - pr.top - dragOff[1];
  
  // Keep within poster bounds
  x = Math.max(0, Math.min(x, pr.width - selected.offsetWidth));
  y = Math.max(0, Math.min(y, pr.height - selected.offsetHeight));
  
  selected.style.left = x + "px";
  selected.style.top = y + "px";
}

function dragEnd(e){ 
  // Clean up all event listeners
  window.removeEventListener("mousemove", dragMove);
  window.removeEventListener("mousemove", resizeMove);
  
  // Reset states
  isDragging = false;
  resizeMode = null;
  
  // Save state after drag/resize operation
  if(selected) {
    saveState();
  }
}

function resizeMove(e){
  if(!selected || !resizeMode) return;
  
  e.preventDefault();
  const pr = poster.getBoundingClientRect();
  const dx = e.clientX - resizeStart.mx;
  const dy = e.clientY - resizeStart.my;
  
  let newW = resizeStart.w;
  let newH = resizeStart.h;
  let newX = resizeStart.x;
  let newY = resizeStart.y;
  
  // Calculate new dimensions based on resize handle
  switch(resizeMode){
    case 'se': newW += dx; newH += dy; break;
    case 'sw': newW -= dx; newH += dy; newX += dx; break;
    case 'ne': newW += dx; newH -= dy; newY += dy; break;
    case 'nw': newW -= dx; newH -= dy; newX += dx; newY += dy; break;
    case 'e': newW += dx; break;
    case 'w': newW -= dx; newX += dx; break;
    case 's': newH += dy; break;
    case 'n': newH -= dy; newY += dy; break;
  }
  
  // Apply minimum sizes
  newW = Math.max(20, newW);
  newH = Math.max(20, newH);
  
  // Keep within poster bounds
  newX = Math.max(0, Math.min(newX, pr.width - newW));
  newY = Math.max(0, Math.min(newY, pr.height - newH));
  
  // Apply new dimensions
  selected.style.width = newW + "px";
  selected.style.height = newH + "px";
  selected.style.left = newX + "px";
  selected.style.top = newY + "px";
}

// Initialize existing elements
["candidateBox","sloganBox","header","footer","ribbon"].forEach(id=>{
  const el = $("#"+id);
  if(id==="header" || id==="footer") el.style.position="absolute";
  makeDraggable(el);
});



// Enhanced event delegation for all poster interactions
poster.addEventListener("mousedown", e=>{
  
  // Prevent default to avoid text selection issues
  if(!e.target.contentEditable || e.target.contentEditable === "false") {
    e.preventDefault();
  }
  
  // Find the clickable element - check for specific IDs and draggable class
  const clickedElement = e.target.closest(".draggable, #header, #footer, #candidateBox, #sloganBox, #ribbon") || 
                         (e.target.dataset.draggable === "true" ? e.target : null) ||
                         (e.target.contentEditable === "true" ? e.target : null);

  
  // Handle resize
  if(e.target.classList.contains("resize-handle")){
    e.stopPropagation();
    const el = e.target.closest(".draggable, #header, #footer, #candidateBox, #sloganBox, #ribbon");
    if(el && el === selected) {
      resizeMode = e.target.dataset.resize;
      const rect = el.getBoundingClientRect();
      const pr = poster.getBoundingClientRect();
      resizeStart = {
        w: el.offsetWidth,
        h: el.offsetHeight,
        x: rect.left - pr.left,
        y: rect.top - pr.top,
        mx: e.clientX,
        my: e.clientY
      };
      window.addEventListener("mousemove", resizeMove);
      window.addEventListener("mouseup", dragEnd, {once:true});
    }
    return;
  }
  
  if(!clickedElement) {
    // Clicked on empty space, deselect
    select(null);
    return;
  }
  
  // Select the clicked element
  select(clickedElement);
  
  // Handle content editing for text elements
  if(clickedElement.contentEditable === "true" && e.detail === 1 && !e.ctrlKey && !e.metaKey){
    // Allow text editing on double click
    return;
  }
  
  // Start dragging only if we have a valid selection
  if(selected) {
    isDragging = true;
    const rect = selected.getBoundingClientRect();
    const pr = poster.getBoundingClientRect();
    dragOff = [e.clientX - rect.left, e.clientY - rect.top];
    window.addEventListener("mousemove", dragMove);
    window.addEventListener("mouseup", dragEnd, {once:true});
  }
});

// Clear selection when clicking outside poster
document.addEventListener("mousedown", e=>{
  // If click is outside the poster area and not in the panel, clear selection
  if(!poster.contains(e.target) && !e.target.closest('.panel') && !e.target.closest('.toolbar')){
    select(null);
  }
});

// Prevent context menu on resize handles
poster.addEventListener("contextmenu", e=>{
  if(e.target.classList.contains("resize-handle")) e.preventDefault();
});

// Keyboard shortcuts
document.addEventListener("keydown", e=>{
  // ESC key to clear selection (works globally)
  if(e.key === "Escape"){
    e.preventDefault();
    select(null);
    return;
  }
  
  if(!selected) return;
  
  // Delete selected element (but not core elements)
  if(e.key === "Delete" || e.key === "Backspace"){
    if(!["header","footer","candidateBox","sloganBox","ribbon"].includes(selected.id)){
      selected.remove();
      select(null);
      saveState();
      e.preventDefault();
    }
  }
  
  // Arrow key movement
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){
    if(selected.contentEditable === "true" && !e.ctrlKey && !e.metaKey) return; // Allow text editing
    
    e.preventDefault();
    const step = e.shiftKey ? 10 : 1;
    const current = { x: parseInt(selected.style.left) || 0, y: parseInt(selected.style.top) || 0 };
    
    switch(e.key){
      case "ArrowLeft": current.x -= step; break;
      case "ArrowRight": current.x += step; break;
      case "ArrowUp": current.y -= step; break;
      case "ArrowDown": current.y += step; break;
    }
    
    // Keep within bounds
    const pr = poster.getBoundingClientRect();
    current.x = Math.max(0, Math.min(current.x, pr.width - selected.offsetWidth));
    current.y = Math.max(0, Math.min(current.y, pr.height - selected.offsetHeight));
    
    selected.style.left = current.x + "px";
    selected.style.top = current.y + "px";
  }
  
  // Escape to deselect
  if(e.key === "Escape"){
    select(null);
  }
});

// Double-click to edit text elements
poster.addEventListener("dblclick", e=>{
  e.preventDefault();
  e.stopPropagation();
  const el = e.target.closest(".draggable");
  if(el && el.contentEditable === "true"){
    // Enable text editing mode
    el.style.cursor = "text";
    el.focus();
    // Select all text
    const range = document.createRange();
    range.selectNodeContents(el);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
});

// Handle blur event for text elements to restore draggable cursor
poster.addEventListener("blur", e=>{
  if(e.target.contentEditable === "true"){
    e.target.style.cursor = "move";
  }
}, true);

/* ========= Element buttons ========= */
$("#addText").addEventListener("click", ()=>{
  const div = document.createElement("div");
  div.textContent = (ids.uiLang.value==="bn" ? "সম্পাদনাযোগ্য টেক্সট" : "Editable Text");
  Object.assign(div.style,{ left:"120px", top:"260px", padding:"6px 10px", fontWeight:"800", background:"#ffffffc8", border:"1px solid #e6e9f4", borderRadius:"8px", fontFamily:(ids.uiLang.value==="bn"?"var(--bangla)":"var(--latin)"), minWidth:"100px", minHeight:"30px" });
  div.contentEditable = "true";
  poster.appendChild(div);
  makeDraggable(div);
  select(div);
});
$("#addShape").addEventListener("click", ()=>{
  const box = document.createElement("div");
  Object.assign(box.style,{ left:"80px", top:"420px", width:"220px", height:"90px", background: ids.cAccent.value+"55", border:"2px solid "+ids.cAccent.value, borderRadius:"12px" });
  poster.appendChild(box);
  makeDraggable(box);
  select(box);
});
$("#addImage").addEventListener("click", ()=>{
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="image/*";
  inp.onchange = ev=>{
    const file = ev.target.files[0]; if(!file) return;
    const img = document.createElement("img");
    img.style.left="140px"; img.style.top="520px"; img.style.width="240px"; img.style.height="auto"; img.style.borderRadius="10px"; img.style.boxShadow="0 6px 16px rgba(0,0,0,.12)"; img.style.minWidth="50px"; img.style.minHeight="50px";
    const r = new FileReader();
    r.onload=()=>{ 
      img.src=r.result; 
      poster.appendChild(img); 
      makeDraggable(img);
      select(img);
    };
    r.readAsDataURL(file);
  };
  inp.click();
});
$("#bringFront").addEventListener("click", ()=>{ if(selected){ selected.style.zIndex = (parseInt(selected.style.zIndex||"1")+1) }});
$("#sendBack").addEventListener("click", ()=>{ if(selected){ selected.style.zIndex = (parseInt(selected.style.zIndex||"1")-1) }});
$("#deleteSel").addEventListener("click", ()=>{ if(selected && !["header","footer","candidateBox","sloganBox","ribbon"].includes(selected.id)){ selected.remove(); selected=null; } });

/* ========= Reset / Print ========= */
$("#resetLayout").addEventListener("click", ()=>{
  $("#header").style.left="0"; $("#header").style.top="0"; $("#header").style.right="0";
  $("#candidateBox").style.left="32px"; $("#candidateBox").style.bottom="220px"; $("#candidateBox").style.top=""; $("#candidateBox").style.right="";
  $("#sloganBox").style.left="32px"; $("#sloganBox").style.right="32px"; $("#sloganBox").style.bottom="76px";
  $("#footer").style.left="0"; $("#footer").style.right="0"; $("#footer").style.bottom="0";
  
  // Reset header shape
  const shapeClasses = ["header-wave", "header-curve-bottom", "header-arch", "header-diagonal", "header-rounded", "header-scoop", "header-mountains", "header-triangle"];
  const footerShapeClasses = ["footer-wave", "footer-curve-bottom", "footer-arch", "footer-diagonal", "footer-rounded", "footer-scoop", "footer-mountains", "footer-triangle"];
  shapeClasses.forEach(cls => ids.header.classList.remove(cls));
  footerShapeClasses.forEach(cls => ids.footer.classList.remove(cls));
  $$("#headerShapes .chip").forEach(c=>c.classList.remove("active"));
  $("#headerShapes .chip[data-shape='default']").classList.add("active");
  
  // Reset ribbon style
  const ribbonClasses = ["ribbon-classic", "ribbon-banner", "ribbon-corner", "ribbon-curved", "ribbon-badge", "ribbon-stamp", "ribbon-hidden"];
  const ribbonPosClasses = ["ribbon-pos-top-left", "ribbon-pos-center", "ribbon-pos-bottom-right", "ribbon-pos-bottom-left"];
  ribbonClasses.forEach(cls => ids.ribbon.classList.remove(cls));
  ribbonPosClasses.forEach(cls => ids.ribbon.classList.remove(cls));
  ids.ribbon.classList.add("ribbon-classic");
  $$("#ribbonStyles .chip").forEach(c=>c.classList.remove("active"));
  $("#ribbonStyles .chip[data-ribbon='classic']").classList.add("active");
  ids.ribbonPosition.value = "top-right";
  
  // Reset layout modes
  const layoutClasses = ["layout-swapped", "layout-inverted", "layout-centered", "layout-minimal-header", "layout-minimal-footer"];
  layoutClasses.forEach(cls => poster.classList.remove(cls));
  ids.layoutMode.value = "normal";
  isLayoutSwapped = false;
  
  randomRibbon();
  buildBaseBG(); applyBG();
  select(null);
});

// Print Function - Print only the poster canvas
async function printPoster() {
  setStatus(ids.uiLang.value==="bn" ? "প্রিন্টের জন্য প্রস্তুত করা হচ্ছে…" : "Preparing for print…");
  
  // Temporarily remove transform for clean capture
  const z = poster.style.transform; 
  poster.style.transform="";
  
  // Create canvas from poster
  const canvas = await html2canvas(poster, {backgroundColor:"#ffffff", scale:2});
  poster.style.transform=z;
  
  // Create a new window for printing
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Election Poster - Print</title>
      <style>
        body { 
          margin: 0; 
          padding: 0; 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          min-height: 100vh;
          background: white;
        }
        img { 
          max-width: 100%; 
          max-height: 100vh; 
          object-fit: contain;
        }
        @media print {
          body { margin: 0; }
          img { 
            width: 100%; 
            height: auto; 
            max-height: none;
            object-fit: contain;
            page-break-inside: avoid;
          }
        }
      </style>
    </head>
    <body>
      <img src="${canvas.toDataURL('image/png')}" alt="Election Poster" />
    </body>
    </html>
  `);
  
  printWindow.document.close();
  
  // Wait for image to load then print
  printWindow.onload = function() {
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  };
  
  setStatus(ids.uiLang.value==="bn" ? "প্রিন্ট ডায়ালগ খোলা হয়েছে।" : "Print dialog opened.");
}

$("#print").addEventListener("click", printPoster);

/* ========= i18n ========= */
const I18N = {
  en: {
    settings:"Poster Settings", size:"Size", lang:"Language UI", primary:"Primary", secondary:"Secondary", accent:"Accent", text:"Text",
    content:"Content", party:"Party", election:"Election", candidate:"Candidate", role:"Role", slogan:"Slogan", ribbonText:"Ribbon Text",
    hashtag:"Hashtag", media:"Media", partyLogo:"Party Logo", candidatePhoto:"Candidate Photo", symbol:"Symbol",
    clearMedia:"Clear media", elements:"Elements", addText:"Add Text", addShape:"Add Shape", addImage:"Add Image",
    bringFront:"Bring Front", sendBack:"Send Back", delete:"Delete", templates:"Templates", headerShape:"Header Shape",
    ribbonStyle:"Ribbon Style", ribbonPosition:"Position", layoutSwap:"Layout Swap", swapHeaderFooter:"Swap Header ⇄ Footer",
    invertLayout:"Invert Layout", layoutMode:"Layout Mode", project:"Project", saveProject:"Save Project", loadProject:"Load Project",
    undo:"↶ Undo", redo:"↷ Redo", textFormat:"Text Format", fontFamily:"Font", fontSize:"Size", bold:"Bold", italic:"Italic", underline:"Underline", presets:"Presets",
    export:"Export", exportPNG:"Export PNG", exportPDF:"Export PDF", resetLayout:"Reset Layout", print:"Print",
    placeholders:{ party:"Party Name", election:"National Election 2026", candidate:"Candidate Name", role:"Constituency • Dhaka-1", slogan:"Progress • Stability • Prosperity", ribbonText:"BANGLADESH 2026", hashtag:"#Vote2026" },
    defaults:{ party:"Party Name", election:"National Election 2026", candidate:"Candidate Name", role:"Constituency • Dhaka-1", slogan:"Progress • Stability • Prosperity", ribbonText:"BANGLADESH 2026", hashtag:"#Vote2026", ribbon:"BANGLADESH 2026", footer:"Election Commission Compliant Layout" }
  },
  bn: {
    settings:"পোস্টার সেটিংস", size:"আকার", lang:"ভাষা", primary:"প্রাইমারি", secondary:"সেকেন্ডারি", accent:"অ্যাকসেন্ট", text:"টেক্সট",
    content:"বিষয়বস্তু", party:"দল", election:"নির্বাচন", candidate:"প্রার্থী", role:"পদ/আসন", slogan:"স্লোগান", ribbonText:"রিবন টেক্সট",
    hashtag:"হ্যাশট্যাগ", media:"মিডিয়া", partyLogo:"দলের লোগো", candidatePhoto:"প্রার্থীর ছবি", symbol:"প্রতীক",
    clearMedia:"মিডিয়া মুছুন", elements:"উপাদান", addText:"টেক্সট যোগ করুন", addShape:"আকৃতি যোগ করুন", addImage:"ছবি যোগ করুন",
    bringFront:"সামনে আনুন", sendBack:"পেছনে পাঠান", delete:"মুছুন", templates:"টেমপ্লেট", headerShape:"হেডার আকৃতি",
    ribbonStyle:"রিবন স্টাইল", ribbonPosition:"অবস্থান", layoutSwap:"লেআউট সোয়াপ", swapHeaderFooter:"হেডার ⇄ ফুটার",
    invertLayout:"উল্টান", layoutMode:"লেআউট মোড", project:"প্রকল্প", saveProject:"প্রকল্প সংরক্ষণ", loadProject:"প্রকল্প লোড",
    undo:"↶ আনডু", redo:"↷ রিডু", textFormat:"টেক্সট ফরম্যাট", fontFamily:"ফন্ট", fontSize:"আকার", bold:"বোল্ড", italic:"ইটালিক", underline:"আন্ডারলাইন", presets:"প্রিসেট",
    export:"এক্সপোর্ট", exportPNG:"PNG এক্সপোর্ট", exportPDF:"PDF এক্সপোর্ট", resetLayout:"লেআউট রিসেট", print:"প্রিন্ট",
    placeholders:{ party:"দলের নাম", election:"জাতীয় নির্বাচন ২০২৬", candidate:"প্রার্থীর নাম", role:"নির্বাচনী এলাকা • ঢাকা-১", slogan:"অগ্রগতি • স্থিতিশীলতা • সমৃদ্ধি", ribbonText:"বাংলাদেশ ২০২৬", hashtag:"#ভোট২০২৬" },
    defaults:{ party:"দলের নাম", election:"জাতীয় নির্বাচন ২০২৬", candidate:"প্রার্থীর নাম", role:"নির্বাচনী এলাকা • ঢাকা-১", slogan:"অগ্রগতি • স্থিতিশীলতা • সমৃদ্ধি", ribbonText:"বাংলাদেশ ২০২৬", hashtag:"#ভোট২০২৬", ribbon:"বাংলাদেশ ২০২৬", footer:"নির্বাচন কমিশন অনুবর্তী লেআউট" }
  }
};
let lastLang = "bn";
function applyI18N(lang){
  const L = I18N[lang] || I18N.bn;
  $$("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if(L[key]) el.textContent = L[key];
  });
  ids.party.placeholder    = L.placeholders.party;
  ids.election.placeholder = L.placeholders.election;
  ids.candidate.placeholder= L.placeholders.candidate;
  ids.role.placeholder     = L.placeholders.role;
  ids.slogan.placeholder   = L.placeholders.slogan;
  ids.ribbonText.placeholder = L.placeholders.ribbonText;
  ids.hashtag.placeholder  = L.placeholders.hashtag;

  const Prev = I18N[lastLang].defaults;
  const Now  = L.defaults;
  function maybeSwap(inputEl, posterElKey, prevVal, newVal){
    if(inputEl.value.trim() === prevVal){ inputEl.value = newVal; ids[posterElKey].textContent = newVal; }
  }
  maybeSwap(ids.party,     "partyText",     Prev.party,    Now.party);
  maybeSwap(ids.election,  "electionText",  Prev.election, Now.election);
  maybeSwap(ids.candidate, "candidateName", Prev.candidate,Now.candidate);
  maybeSwap(ids.role,      "roleText",      Prev.role,     Now.role);
  maybeSwap(ids.slogan,    "sloganText",    Prev.slogan,   Now.slogan);
  maybeSwap(ids.ribbonText,"ribbon",        Prev.ribbonText,Now.ribbonText);
  maybeSwap(ids.hashtag,   "hashtagText",   Prev.hashtag,  Now.hashtag);

  if(ids.ribbon.textContent.trim() === Prev.ribbon){ ids.ribbon.textContent = Now.ribbon; }
  if($("#footerText").textContent.trim() === Prev.footer){ $("#footerText").textContent = Now.footer; }

  lastLang = lang;
}
ids.uiLang.addEventListener("change", e=> applyI18N(e.target.value));

/* ========= Export ========= */
async function exportPNG(){
  setStatus(ids.uiLang.value==="bn" ? "PNG প্রস্তুত করা হচ্ছে…" : "Rendering PNG…");
  const z = poster.style.transform; poster.style.transform="";
  const canvas = await html2canvas(poster, {backgroundColor:null, scale:2});
  poster.style.transform=z;
  const data = canvas.toDataURL("image/png");
  const a = document.createElement("a");
  a.href = data; a.download = "poster.png"; a.click();
  setStatus(ids.uiLang.value==="bn" ? "PNG সংরক্ষিত।" : "PNG saved.");
}
async function exportPDF(){
  setStatus(ids.uiLang.value==="bn" ? "PDF প্রস্তুত করা হচ্ছে…" : "Rendering PDF…");
  const { jsPDF } = window.jspdf;
  const z = poster.style.transform; poster.style.transform="";
  const canvas = await html2canvas(poster, {backgroundColor:"#ffffff", scale:2});
  poster.style.transform=z;
  const imgData = canvas.toDataURL("image/jpeg", 0.94);
  const w = canvas.width, h = canvas.height;
  const pdf = new jsPDF({orientation: h>=w?"p":"l", unit:"pt", format:[w, h]});
  pdf.addImage(imgData, "JPEG", 0, 0, w, h);
  pdf.save("poster.pdf");
  setStatus(ids.uiLang.value==="bn" ? "PDF সংরক্ষিত।" : "PDF saved.");
}
$("#exportPNG").addEventListener("click", exportPNG);
$("#exportPDF").addEventListener("click", exportPDF);

/* ========= Mobile & Responsive Utilities ========= */
let isMobile = window.innerWidth <= 768;
let isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;

// Update mobile state on resize
window.addEventListener('resize', ()=>{
  isMobile = window.innerWidth <= 768;
  isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
  updatePosterScale();
});

// Dynamic poster scaling for mobile
function updatePosterScale(){
  const poster = $("#poster");
  const canvasWrap = $(".canvas-wrap");
  if(!poster || !canvasWrap) return;
  
  if(isMobile || isTablet) {
    const containerWidth = canvasWrap.clientWidth - 16;
    const containerHeight = canvasWrap.clientHeight - 16;
    const posterWidth = poster.offsetWidth;
    const posterHeight = poster.offsetHeight;
    
    const scaleX = containerWidth / posterWidth;
    const scaleY = containerHeight / posterHeight;
    const scale = Math.min(scaleX, scaleY, 1);
    
    if(scale < 1) {
      poster.style.transform = `scale(${scale})`;
    } else {
      poster.style.transform = 'scale(1)';
    }
  } else {
    poster.style.transform = 'scale(1)';
  }
}

// Touch event handling for mobile drag/resize
let touchStartPos = null;
let touchElement = null;

function addTouchSupport(){
  poster.addEventListener('touchstart', e=>{
    const touch = e.touches[0];
    const clickedElement = touch.target.closest('.draggable');
    
    if(touch.target.classList.contains('resize-handle')){
      e.preventDefault();
      const el = touch.target.closest('.draggable');
      if(el) {
        select(el);
        resizeMode = touch.target.dataset.resize;
        const rect = el.getBoundingClientRect();
        const pr = poster.getBoundingClientRect();
        resizeStart = {
          w: el.offsetWidth,
          h: el.offsetHeight,
          x: rect.left - pr.left,
          y: rect.top - pr.top,
          mx: touch.clientX,
          my: touch.clientY
        };
        touchElement = el;
        touchStartPos = {x: touch.clientX, y: touch.clientY};
      }
      return;
    }
    
    if(!clickedElement) {
      select(null);
      return;
    }
    
    select(clickedElement);
    touchElement = clickedElement;
    
    if(clickedElement.contentEditable === "true") {
      return; // Allow text editing
    }
    
    e.preventDefault();
    isDragging = true;
    const rect = clickedElement.getBoundingClientRect();
    const pr = poster.getBoundingClientRect();
    dragOff = [touch.clientX - rect.left, touch.clientY - rect.top];
    touchStartPos = {x: touch.clientX, y: touch.clientY};
  });
  
  poster.addEventListener('touchmove', e=>{
    if(!touchElement || !touchStartPos) return;
    e.preventDefault();
    
    const touch = e.touches[0];
    
    if(resizeMode) {
      // Handle resize
      const dx = touch.clientX - resizeStart.mx;
      const dy = touch.clientY - resizeStart.my;
      
      let newW = resizeStart.w;
      let newH = resizeStart.h;
      let newX = resizeStart.x;
      let newY = resizeStart.y;
      
      switch(resizeMode){
        case 'se': newW += dx; newH += dy; break;
        case 'sw': newW -= dx; newH += dy; newX += dx; break;
        case 'ne': newW += dx; newH -= dy; newY += dy; break;
        case 'nw': newW -= dx; newH -= dy; newX += dx; newY += dy; break;
        case 'e': newW += dx; break;
        case 'w': newW -= dx; newX += dx; break;
        case 's': newH += dy; break;
        case 'n': newH -= dy; newY += dy; break;
      }
      
      newW = Math.max(20, newW);
      newH = Math.max(20, newH);
      
      const pr = poster.getBoundingClientRect();
      newX = Math.max(0, Math.min(newX, pr.width - newW));
      newY = Math.max(0, Math.min(newY, pr.height - newH));
      
      touchElement.style.width = newW + "px";
      touchElement.style.height = newH + "px";
      touchElement.style.left = newX + "px";
      touchElement.style.top = newY + "px";
    } else if(isDragging) {
      // Handle drag
      const pr = poster.getBoundingClientRect();
      let x = touch.clientX - pr.left - dragOff[0];
      let y = touch.clientY - pr.top - dragOff[1];
      
      x = Math.max(0, Math.min(x, pr.width - touchElement.offsetWidth));
      y = Math.max(0, Math.min(y, pr.height - touchElement.offsetHeight));
      
      touchElement.style.left = x + "px";
      touchElement.style.top = y + "px";
    }
  });
  
  poster.addEventListener('touchend', e=>{
    touchElement = null;
    touchStartPos = null;
    isDragging = false;
    resizeMode = null;
  });
}

// Initialize mobile support
document.addEventListener('DOMContentLoaded', ()=>{
  addTouchSupport();
  setTimeout(updatePosterScale, 100);
});

/* ========= Init ========= */
applyColors();
buildBaseBG(); setTemplateOverlay("banner"); applyBG();
randomRibbon();
applyI18N("bn"); // Bangla default
// Event delegation handles all interactions now
saveState(); // Save initial state
setStatus("প্রস্তুত।");
</script>

</body>
</html>